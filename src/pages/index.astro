---
import Layout from "../layouts/Layout.astro"
import Decompte from "../components/decompte.astro"
import Tag from "../components/Tag.astro"
import Button from "../components/Button.astro"
import Marquee from "../components/Banniere.astro"
import { getallPartenaires } from "../../backend/backend.mjs";
const partenaires = await getallPartenaires();
---

<Layout>
	<div class="flex flex-col space-y-15 justify-center items-center mt-25 px-4">
		<h1
			class="text-white font-oi text-center text-4xl sm:text-5xl md:text-6xl lg:text-7xl xl:text-8xl leading-tight sm:leading-tight md:leading-normal tracking-wide">
			Le défi 24h <br>C'est bientôt !
		</h1>
		<div class="flex flex-col space-y-7">
			<Tag bgClass="bg-tertiary" colorClass="text-white" text="17 JANVIER 2026" />
			<div class="text-center px-10">
				<Button bgClass="bg-white" colorClass="text-primary" text="Inscription" page="inscription" />
			</div>
		</div>
	</div>
	<div class="mt-25">
		<Marquee />
	</div>
	<div class="flex flex-col items-center mt-25 space-y-15">
		<div class="space-y-5 flex flex-col items-center">
			<div
				class="inline-block space-y-2 lg:space-y-5 bg-white/80 w-8/10 px-6 sm:px-8 md:px-10 py-7 md:py-10 lg:py-15 rounded-2xl font-nohemi shadow-[0_0_0_2px_black,3px_3px_0px_1px_black] sm:shadow-[0_0_0_3px_black,4px_4px_0px_2px_black]">
				<h2 class="font-oi uppercase text-primary text-4xl sm:text-5xl md:text-6xl lg:text-7xl xl:text-8xl">24
					heures</h2>
				<p
					class="font-nohemi text-tertiary text-xl sm:text-2xl md:text-2xl lg:text-3xl xl:text-3xl font-normal">
					Pour créer, rire... et ne pas dormir !</p>
			</div>
			<div class="w-8/10 flex flex-col lg:flex-row gap-5 lg:items-stretch">
				<div
					class="space-y-2 lg:space-y-5 w-full bg-white/80 px-6 sm:px-8 md:px-10 py-7 md:py-10 lg:py-15 rounded-2xl shadow-[0_0_0_2px_black,3px_3px_0px_1px_black] sm:shadow-[0_0_0_3px_black,4px_4px_0px_2px_black]">
				<p class="font-nohemi text-black text-sm sm:text-base md:text-lg font-normal">
					Le Défi 24H, c'est l'événement incontournable du cursus MMI : 24 heures non-stop pour créer,
					imaginer et repousser vos limites sur un thème surprise. Que vous soyez fan de design, de
					montage,
					de développement ou juste là pour l'ambiance (et les pizzas), tout le monde a sa place !</p>
				</div>
				<div
					class="space-y-2 lg:space-y-5 w-full bg-gradient-to-b from-[#FFC567] to-[#FD5A46] px-6 sm:px-8 md:px-10 py-7 md:py-10 lg:py-15 rounded-2xl shadow-[0_0_0_2px_black,3px_3px_0px_1px_black] sm:shadow-[0_0_0_3px_black,4px_4px_0px_2px_black] flex justify-center items-center">
					<p class="font-nohemi text-white text-base sm:text-lg md:text-xl lg:text-2xl xl:text-3xl">Prêt a relever le challenge ?
					</p>
				</div>
			</div>
			<div
				class="inline-block space-y-2 lg:space-y-5 bg-white/80 w-8/10 px-6 sm:px-8 md:px-10 py-7 md:py-10 lg:py-15 rounded-2xl font-nohemi shadow-[0_0_0_2px_black,3px_3px_0px_1px_black] sm:shadow-[0_0_0_3px_black,4px_4px_0px_2px_black]">
				<p class="font-nohemi text-black text-sm sm:text-base md:text-lg font-normal">
					Au Défi 24H, on joue en équipe ! Regroupe 4 ou 5 génies créatifs (ou juste tes potes, ça marche
					aussi),
					et prépare-toi à vivre une aventure intense. Chacun apporte ses talents, que ce soit pour le design,
					le
					montage ou simplement pour encourager. Une seule règle : pas plus de 5, sinon c'est la révolution !
				</p>
			</div>
		</div>
		<div class="flex mx-10 lg:mx-0 space-x-5 lg:space-x-10">
			<button id="openCreateModal" class="inline-block bg-primary text-white px-6 sm:px-8 md:px-10 py-2 sm:py-2.5 md:py-3 rounded-full font-nohemi font-black text-base sm:text-lg shadow-[0_0_0_2px_black,3px_3px_0px_1px_black] sm:shadow-[0_0_0_3px_black,4px_4px_0px_2px_black] hover:scale-105 active:scale-95 transition-transform duration-150 ease-in text-center cursor-pointer">
				Créer mon équipe
			</button>
			<button id="openJoinModal" class="inline-block bg-white text-primary px-6 sm:px-8 md:px-10 py-2 sm:py-2.5 md:py-3 rounded-full font-nohemi font-black text-base sm:text-lg shadow-[0_0_0_2px_black,3px_3px_0px_1px_black] sm:shadow-[0_0_0_3px_black,4px_4px_0px_2px_black] hover:scale-105 active:scale-95 transition-transform duration-150 ease-in text-center cursor-pointer">
				Intégrer une équipe
			</button>
		</div>
	</div>

	<div id="createModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
		<div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-[0_0_0_3px_black,4px_4px_0px_2px_black] relative">
			<button id="closeCreateModal" class="absolute top-4 right-4 text-2xl hover:text-primary transition">✕</button>
			
			<h2 class="font-oi text-primary text-3xl md:text-4xl text-center mb-6">Créer une équipe</h2>
			
			<form id="createForm" class="space-y-4" enctype="multipart/form-data">
				<div>
					<label for="equipeName" class="block font-nohemi text-black text-sm sm:text-base mb-2">Nom de l'équipe</label>
					<input 
						type="text" 
						id="equipeName" 
						name="equipeName" 
						required 
						placeholder="Entrez le nom de votre équipe"
						class="w-full px-4 py-3 border-3 border-black rounded-xl font-nohemi text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-primary"
					/>
				</div>
				
				<div>
					<label for="equipeLogo" class="block font-nohemi text-black text-sm sm:text-base mb-2">Logo de l'équipe (optionnel)</label>
					<input 
						type="file" 
						id="equipeLogo" 
						name="equipeLogo" 
						accept="image/*"
						class="w-full px-4 py-3 border-3 border-black rounded-xl font-nohemi focus:outline-none focus:ring-2 focus:ring-primary file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-opacity-90"
					/>
				</div>
				
				<button 
					type="submit"
					class="w-full bg-primary text-white px-6 py-3 rounded-xl border-3 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] font-nohemi text-base sm:text-lg font-bold hover:scale-105 active:scale-95 transition-transform"
				>
					Créer l'équipe
				</button>
			</form>
			
			<div id="createMessage" class="mt-4 text-center font-nohemi text-sm sm:text-base"></div>
		</div>
	</div>

	<div id="joinModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
		<div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-[0_0_0_3px_black,4px_4px_0px_2px_black] relative">
			<button id="closeModal" class="absolute top-4 right-4 text-2xl hover:text-primary transition">✕</button>
			
			<h2 class="font-oi text-primary text-3xl md:text-4xl text-center mb-6">Rejoindre une équipe</h2>
			
			<form id="joinForm" class="space-y-4">
				<div>
					<label for="equipeId" class="block font-nohemi text-black text-sm sm:text-base mb-2">Code de l'équipe</label>
					<input 
						type="text" 
						id="equipeId" 
						name="equipeId" 
						required 
						placeholder="Entrez l'Code de l'équipe"
						class="w-full px-4 py-3 border-3 border-black rounded-xl font-nohemi text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-primary"
					/>
				</div>
				
				<button 
				type="submit"
				class="w-full bg-primary text-white px-6 py-3 rounded-xl border-3 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] font-nohemi text-base sm:text-lg font-bold hover:scale-105 active:scale-95 transition-transform"
				>
				Rejoindre l'équipe
			</button>
			<p class="font-nohemi text-center text-primary mt-5">Le code se trouve dans le profile des membres de l'équipe</p>
			</form>
			
			<div id="message" class="mt-4 text-center font-nohemi text-sm sm:text-base"></div>
		</div>
	</div>
	<div class="mt-25 flex flex-col mx-auto w-8/10 space-y-5 lg:space-y-10">
		<div
			class="inline-block space-y-2 lg:space-y-5 bg-lightprimary w-full px-6 sm:px-8 md:px-10 py-7 md:py-10 lg:py-15 rounded-2xl font-nohemi shadow-[0_0_0_2px_black,3px_3px_0px_1px_black] sm:shadow-[0_0_0_3px_black,4px_4px_0px_2px_black]">
			<h2 class="font-oi uppercase text-white text-2xl sm:text-4xl md:text-5xl lg:text-6xl xl:text-7xl">Nos<br>partenaires</h2>
		</div>
		<div class="flex flex-col lg:grid lg:grid-cols-4 gap-5 w-full">
			{partenaires.map((partenaire) => (
			<div class="inline-block space-y-2 lg:space-y-5 bg-white w-full px-6 sm:px-8 md:px-10 py-7 md:py-10 lg:py-15 rounded-2xl font-nohemi shadow-[0_0_0_2px_black,3px_3px_0px_1px_black] sm:shadow-[0_0_0_3px_black,4px_4px_0px_2px_black] flex justify-center items-center">
				<img src={partenaire.img} alt={partenaire.nom} class="max-h-16 object-contain" />
			</div>
			))}
		</div>
	</div>
	<div class="space-y-2 lg:space-y-5 bg-white/80 w-8/10 lg:w-5/10 px-6 sm:px-8 md:px-10 py-7 md:py-10 lg:py-15 rounded-2xl font-nohemi shadow-[0_0_0_2px_black,3px_3px_0px_1px_black] sm:shadow-[0_0_0_3px_black,4px_4px_0px_2px_black] flex flex-col items-center mx-auto mt-25">
		<p class="font-nohemi text-primary text-base sm:text-lg md:text-xl lg:text-2xl xl:text-3xl">Une question ? Besoin d'infos ?</p>
		<h2 class="font-oi uppercase text-tertiary text-2xl sm:text-3xl md:text-4xl lg:text-5xl xl:text-6xl text-center">Contactez-nous !</h2>
		<Button bgClass="bg-primary" colorClass="text-white" text="Envoyer un message" page="contact" />
	</div>
</Layout>

<script>
	const userDataString = localStorage.getItem('user');

	if (userDataString) {
		try {
			const userData = JSON.parse(userDataString);
			if (userData.email) {
				const avatarImg = document.createElement("img");
				avatarImg.src = userData.avatar;
				avatarImg.alt = "Avatar";
			}
		} catch (error) {
			console.error('Erreur lors de la lecture des données utilisateur', error);
		}
	}

	const openCreateModalBtn = document.getElementById('openCreateModal');
	const closeCreateModalBtn = document.getElementById('closeCreateModal');
	const createModal = document.getElementById('createModal');
	const createForm = document.getElementById('createForm') as HTMLFormElement;
	const createMessageDiv = document.getElementById('createMessage') as HTMLDivElement;

	openCreateModalBtn?.addEventListener('click', () => {
		createModal?.classList.remove('hidden');
	});

	closeCreateModalBtn?.addEventListener('click', () => {
		createModal?.classList.add('hidden');
		createMessageDiv.textContent = '';
		createForm?.reset();
	});

	createModal?.addEventListener('click', (e) => {
		if (e.target === createModal) {
			createModal.classList.add('hidden');
			createMessageDiv.textContent = '';
			createForm?.reset();
		}
	});

	const openJoinModalBtn = document.getElementById('openJoinModal');
	const closeModalBtn = document.getElementById('closeModal');
	const joinModal = document.getElementById('joinModal');
	const joinForm = document.getElementById('joinForm') as HTMLFormElement;
	const messageDiv = document.getElementById('message') as HTMLDivElement;

	openJoinModalBtn?.addEventListener('click', () => {
		joinModal?.classList.remove('hidden');
	});

	closeModalBtn?.addEventListener('click', () => {
		joinModal?.classList.add('hidden');
		messageDiv.textContent = '';
		joinForm?.reset();
	});

	joinModal?.addEventListener('click', (e) => {
		if (e.target === joinModal) {
			joinModal.classList.add('hidden');
			messageDiv.textContent = '';
			joinForm?.reset();
		}
	});

	createForm?.addEventListener('submit', async (e) => {
		e.preventDefault();
		
		const equipeNameInput = document.getElementById('equipeName') as HTMLInputElement;
		const equipeLogoInput = document.getElementById('equipeLogo') as HTMLInputElement;
		const equipeName = equipeNameInput.value.trim();
		
		const userDataString = localStorage.getItem('user');
		if (!userDataString) {
			createMessageDiv.textContent = 'Vous devez être connecté pour créer une équipe.';
			createMessageDiv.style.color = 'red';
			setTimeout(() => {
				window.location.href = '/connexion';
			}, 2000);
			return;
		}
		
		const userData = JSON.parse(userDataString);
		const userId = userData.id;

		try {
			const formData = new FormData();
			formData.append('nom', equipeName);
			formData.append('userId', userId);
			
			if (equipeLogoInput.files && equipeLogoInput.files[0]) {
				formData.append('logo', equipeLogoInput.files[0]);
			}

			const response = await fetch('/apis/create-equipe', {
				method: 'POST',
				body: formData
			});

			const data = await response.json();

			if (response.ok) {
				createMessageDiv.textContent = `${data.message} ID: ${data.equipe.id}`;
				createMessageDiv.style.color = 'green';
				
				setTimeout(() => {
					createModal?.classList.add('hidden');
					window.location.reload();
				}, 2000);
			} else {
				createMessageDiv.textContent = data.error || 'Erreur lors de la création de l\'équipe';
				createMessageDiv.style.color = 'red';
			}
		} catch (error) {
			createMessageDiv.textContent = 'Erreur de connexion au serveur';
			createMessageDiv.style.color = 'red';
		}
	});

	joinForm?.addEventListener('submit', async (e) => {
		e.preventDefault();
		
		const equipeIdInput = document.getElementById('equipeId') as HTMLInputElement;
		const equipeId = equipeIdInput.value.trim();
		
		const userDataString = localStorage.getItem('user');
		if (!userDataString) {
			messageDiv.textContent = 'Vous devez être connecté pour rejoindre une équipe.';
			messageDiv.style.color = 'red';
			setTimeout(() => {
				window.location.href = '/connexion';
			}, 2000);
			return;
		}
		
		const userData = JSON.parse(userDataString);
		const userId = userData.id;

		try {
			const response = await fetch('/apis/join-equipe', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ equipeId, userId })
			});

			const data = await response.json();

			if (response.ok) {
				messageDiv.textContent = data.message;
				messageDiv.style.color = 'green';
				
				// Fermer la modale et rafraîchir après succès
				setTimeout(() => {
					joinModal?.classList.add('hidden');
					window.location.reload();
				}, 2000);
			} else {
				messageDiv.textContent = data.error || 'Erreur lors de la jonction à l\'équipe';
				messageDiv.style.color = 'red';
			}
		} catch (error) {
			messageDiv.textContent = 'Erreur de connexion au serveur';
			messageDiv.style.color = 'red';
		}
	});
</script>