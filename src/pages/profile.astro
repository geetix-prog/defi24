---
import Layout from "../layouts/Layout.astro";
---

<Layout>
    <div class="flex flex-col space-y-8 sm:space-y-10 md:space-y-15 justify-center items-center mt-16 sm:mt-20 md:mt-25 px-4 sm:px-6">
        <h1
            class="text-white font-oi text-center text-3xl xs:text-4xl sm:text-5xl md:text-6xl lg:text-7xl xl:text-8xl leading-tight tracking-wide">
            Mon profil
        </h1>
        
        <p class="text-white font-nohemi text-center text-sm sm:text-base md:text-lg max-w-lg mb-6 sm:mb-8 md:mb-10">
            Gère tes informations personnelles
        </p>
        
        <div class="bg-white/90 w-full max-w-2xl p-6 sm:p-8 md:p-10 rounded-2xl sm:rounded-3xl shadow-[0_0_0_2px_black,4px_4px_0px_1px_black] sm:shadow-[0_0_0_3px_black,6px_6px_0px_2px_black]">
            <div class="flex items-center gap-4 sm:gap-6 mb-6 sm:mb-8 pb-6 sm:pb-8 border-b-2 sm:border-b-3 border-gray-200">
                <div class="relative shrink-0">
                    <div id="avatarContainer" class="w-20 h-20 sm:w-24 sm:h-24 rounded-full bg-gradient-to-br from-primary to-tertiary flex items-center justify-center text-white font-oi text-3xl sm:text-4xl border-2 sm:border-3 border-black shadow-[0_0_0_2px_black,3px_3px_0px_1px_black]">
                    </div>
                    <button id="memberBadge" class="absolute -bottom-1 -right-1 sm:-bottom-2 sm:-right-2 bg-tertiary text-white px-2 sm:px-3 py-0.5 sm:py-1 rounded-full text-xs font-nohemi font-bold border-2 border-black hidden">
                        Membre
                    </button>
                    <button id="chefBadge" class="absolute -bottom-1 -right-1 sm:-bottom-2 sm:-right-2 bg-primary text-white px-2 sm:px-3 py-0.5 sm:py-1 rounded-full text-xs font-nohemi font-bold border-2 border-black hidden">
                        Chef
                    </button>
                </div>
                <div class="min-w-0 flex-1">
                    <h2 id="userName" class="font-oi text-black text-xl sm:text-2xl md:text-3xl mb-1 truncate">Utilisateur</h2>
                    <p id="userEmail" class="font-nohemi text-gray-600 text-xs sm:text-sm truncate">email@example.com</p>
                </div>
            </div>

            <h3 class="font-nohemi text-primary text-lg sm:text-xl font-bold mb-3 sm:mb-4">Informations</h3>

            <form id="profileForm" class="space-y-4 sm:space-y-5">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="prenom" class="block font-nohemi text-black font-bold mb-2 text-sm sm:text-base">Prénom</label>
                        <input 
                            type="text" 
                            name="prenom" 
                            id="prenom" 
                            required 
                            placeholder="Jean"
                            class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border-2 sm:border-3 border-black rounded-xl sm:rounded-2xl font-nohemi text-sm sm:text-base focus:outline-none focus:ring-2 sm:focus:ring-3 focus:ring-primary transition-all"
                        />
                    </div>
                    <div>
                        <label for="nom" class="block font-nohemi text-black font-bold mb-2 text-sm sm:text-base">Nom</label>
                        <input 
                            type="text" 
                            name="nom" 
                            id="nom" 
                            required 
                            placeholder="Dupont"
                            class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border-2 sm:border-3 border-black rounded-xl sm:rounded-2xl font-nohemi text-sm sm:text-base focus:outline-none focus:ring-2 sm:focus:ring-3 focus:ring-primary transition-all"
                        />
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="email" class="block font-nohemi text-black font-bold mb-2 text-sm sm:text-base">Email</label>
                        <input 
                            type="email" 
                            name="email" 
                            id="email" 
                            required 
                            placeholder="ton-email@example.com"
                            class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border-2 sm:border-3 border-black rounded-xl sm:rounded-2xl font-nohemi text-sm sm:text-base focus:outline-none focus:ring-2 sm:focus:ring-3 focus:ring-primary transition-all"
                        />
                    </div>
                    <div>
                        <label for="promo" class="block font-nohemi text-black font-bold mb-2 text-sm sm:text-base">Année de promotion</label>
                        <select 
                            name="promo" 
                            id="promo" 
                            required
                            class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border-2 sm:border-3 border-black rounded-xl sm:rounded-2xl font-nohemi text-sm sm:text-base focus:outline-none focus:ring-2 sm:focus:ring-3 focus:ring-primary transition-all bg-white cursor-pointer"
                        >
                            <option value="" disabled>- Select -</option>
                            <option value="2025-2028">2025-2028</option>
                            <option value="2024-2027">2024-2027</option>
                            <option value="2023-2026">2023-2026</option>
                            <option value="ancien">Ancien</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="equipe" class="block font-nohemi text-black font-bold mb-2 text-sm sm:text-base">Équipe</label>
                    <input 
                        type="text" 
                        name="equipe" 
                        id="equipe" 
                        readonly
                        placeholder="La team rose"
                        class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border-2 sm:border-3 border-black rounded-xl sm:rounded-2xl font-nohemi text-sm sm:text-base bg-gray-100 cursor-not-allowed"
                    />
                </div>

                <div>
                    <label for="confirmPassword" class="block font-nohemi text-black font-bold mb-2 text-sm sm:text-base">Mot de passe de confirmation</label>
                    <div class="relative">
                        <input 
                            type="password" 
                            name="confirmPassword" 
                            id="confirmPassword" 
                            required
                            placeholder="Entrez votre mot de passe pour confirmer"
                            class="w-full px-4 sm:px-5 py-2.5 sm:py-3.5 border-2 sm:border-3 border-black rounded-xl sm:rounded-2xl font-nohemi text-sm sm:text-base focus:outline-none focus:ring-2 sm:focus:ring-3 focus:ring-primary transition-all pr-11 sm:pr-12"
                        />
                        <button 
                            type="button" 
                            id="toggleConfirmPassword"
                            class="absolute right-3 sm:right-4 top-1/2 -translate-y-1/2 text-gray-600 hover:text-black transition"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 sm:w-5 sm:h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-600 font-nohemi mt-1">Requis pour valider les modifications</p>
                </div>

                <button 
                    type="submit"
                    class="inline-block w-full bg-primary text-white px-6 sm:px-8 md:px-10 py-2.5 sm:py-3 rounded-full font-nohemi font-black text-sm sm:text-base md:text-lg shadow-[0_0_0_2px_black,3px_3px_0px_1px_black] sm:shadow-[0_0_0_3px_black,4px_4px_0px_2px_black] hover:scale-105 active:scale-95 transition-transform duration-150 ease-in text-center"
                >
                    Modifier mes informations
                </button>

                <div id="message" class="text-center font-nohemi font-bold mt-4 text-sm sm:text-base"></div>
            </form>

            <div class="mt-6 pt-6 border-t-3 border-gray-200">
                <button 
                    id="logoutBtn"
                    class="inline-block w-full bg-red-500 text-white px-6 sm:px-8 md:px-10 py-2.5 sm:py-3 rounded-full font-nohemi font-black text-sm sm:text-base md:text-lg shadow-[0_0_0_2px_black,3px_3px_0px_1px_black] sm:shadow-[0_0_0_3px_black,4px_4px_0px_2px_black] hover:scale-105 active:scale-95 transition-transform duration-150 ease-in text-center"
                >
                    Se déconnecter
                </button>
            </div>

            <div id="teamSection" class="mt-8 sm:mt-10 p-4 sm:p-6 bg-pink-100 rounded-xl sm:rounded-2xl border-2 sm:border-3 border-black hidden">
                <h3 class="font-oi text-black text-xl sm:text-2xl mb-2 sm:mb-3">Ton équipe</h3>
                <p class="font-nohemi text-black text-xs sm:text-sm mb-3 sm:mb-4" id="teamDescription">
                    Retrouve les membres de ton équipe. C'est le chef d'équipe qui a le droit de rendre le projet final que toute l'équipe, en attendant, donne tout ce que tu as !
                </p>

                <div class="bg-white p-3 sm:p-4 rounded-xl sm:rounded-2xl border-2 sm:border-3 border-black mb-3 sm:mb-4">
                    <div class="flex items-center gap-2 sm:gap-3 mb-3">
                        <div id="teamLogoContainer" class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gradient-to-br from-primary to-tertiary flex items-center justify-center text-white font-oi text-lg sm:text-xl border-2 border-black shrink-0">
                            TR
                        </div>
                        <div class="min-w-0 flex-1">
                            <h4 id="teamName" class="font-oi text-black text-lg sm:text-xl truncate">La team rose</h4>
                            <p id="teamMemberCount" class="font-nohemi text-gray-600 text-xs sm:text-sm">5 membres</p>
                        </div>
                    </div>

                    <h5 class="font-nohemi text-primary font-bold mb-2 sm:mb-3 text-sm sm:text-base">Membres de l'équipe</h5>
                    <div id="teamMembers" class="space-y-2">
                    </div>
                </div>

                <p class="text-center font-nohemi text-xs text-gray-600">
                    Le chef d'équipe <span id="chefName" class="font-bold text-primary">Marie Dubois</span> doit faire le rendu pour toute l'équipe
                </p>
            </div>
        </div>
    </div>
</Layout>

<script>
    const userDataString = localStorage.getItem('user');
    const messageDiv = document.getElementById('message') as HTMLDivElement;

    if (!userDataString) {
        window.location.href = '/connexion';
    } else {
        try {
            const userData = JSON.parse(userDataString);
            loadProfile(userData.id);
        } catch (error) {
            console.error('Erreur lors de la lecture des données utilisateur', error);
            window.location.href = '/connexion';
        }
    }

    async function loadProfile(userId: string) {
        try {
            const response = await fetch(`/apis/get-profile?userId=${userId}`);
            const data = await response.json();

            console.log('=== DEBUG PROFIL ===');
            console.log('Data reçue:', data);
            console.log('Equipe:', data.equipe);
            console.log('UsersDetails:', data.equipe?.usersDetails);
            console.log('Nombre de membres:', data.equipe?.usersDetails?.length);

            if (!response.ok) {
                throw new Error(data.error || 'Erreur lors du chargement du profil');
            }

            const user = data.user;
            const equipe = data.equipe;

            const prenomInput = document.getElementById('prenom') as HTMLInputElement;
            const nomInput = document.getElementById('nom') as HTMLInputElement;
            const emailInput = document.getElementById('email') as HTMLInputElement;
            const promoInput = document.getElementById('promo') as HTMLSelectElement;
            const userName = document.getElementById('userName');
            const userEmail = document.getElementById('userEmail');
            const avatarContainer = document.getElementById('avatarContainer');

            if (prenomInput) prenomInput.value = user.prenom || '';
            if (nomInput) nomInput.value = user.nom || '';
            if (emailInput) emailInput.value = user.email || '';
            if (promoInput) promoInput.value = user.promo || '';
            
            if (userName) userName.textContent = `${user.prenom} ${user.nom}`;
            if (userEmail) userEmail.textContent = user.email;

            if (avatarContainer) {
                if (user.avatar) {
                    const avatarUrl = `http://127.0.0.1:8090/api/files/users/${user.id}/${user.avatar}`;
                    avatarContainer.innerHTML = `<img src="${avatarUrl}" alt="Avatar" class="w-full h-full object-cover rounded-full">`;
                } else {
                    const initials = `${user.prenom?.charAt(0) || ''}${user.nom?.charAt(0) || ''}`.toUpperCase();
                    avatarContainer.textContent = initials;
                }
            }

            if (equipe) {
                displayTeamInfo(equipe, userId);
            }

        } catch (error) {
            console.error('Erreur:', error);
            messageDiv.textContent = 'Erreur lors du chargement du profil';
            messageDiv.style.color = 'red';
        }
    }

    function displayTeamInfo(equipe: any, currentUserId: string) {
        console.log('=== DEBUG AFFICHAGE ÉQUIPE ===');
        console.log('displayTeamInfo appelé avec:', equipe);
        console.log('Nombre de membres:', equipe.usersDetails?.length);
        console.log('Détails membres:', equipe.usersDetails);
        
        const equipeInput = document.getElementById('equipe') as HTMLInputElement;
        const teamSection = document.getElementById('teamSection');
        const teamName = document.getElementById('teamName');
        const teamMemberCount = document.getElementById('teamMemberCount');
        const teamMembers = document.getElementById('teamMembers');
        const chefName = document.getElementById('chefName');
        const teamLogoContainer = document.getElementById('teamLogoContainer');
        const memberBadge = document.getElementById('memberBadge');
        const chefBadge = document.getElementById('chefBadge');

        if (equipeInput) equipeInput.value = equipe.nom;
        if (teamSection) teamSection.classList.remove('hidden');
        if (teamName) teamName.textContent = equipe.nom;
        
        const membersCount = equipe.usersDetails?.length || 0;
        if (teamMemberCount) {
            teamMemberCount.textContent = `${membersCount} membre${membersCount > 1 ? 's' : ''}`;
        }

        if (teamLogoContainer) {
            if (equipe.logo) {
                const logoUrl = `http://127.0.0.1:8090/api/files/Equipe/${equipe.id}/${equipe.logo}`;
                teamLogoContainer.innerHTML = `<img src="${logoUrl}" alt="Logo" class="w-full h-full object-cover rounded-full">`;
            } else {
                const initials = equipe.nom.split(' ').map((word: string) => word.charAt(0)).join('').toUpperCase().slice(0, 2);
                teamLogoContainer.textContent = initials;
            }
        }

        if (equipe.chef === currentUserId) {
            if (chefBadge) chefBadge.classList.remove('hidden');
            if (memberBadge) memberBadge.classList.add('hidden');
        } else {
            if (memberBadge) memberBadge.classList.remove('hidden');
            if (chefBadge) chefBadge.classList.add('hidden');
        }

        const chefUser = equipe.usersDetails?.find((u: any) => u.id === equipe.chef);
        if (chefName && chefUser) {
            chefName.textContent = `${chefUser.prenom} ${chefUser.nom}`;
        }

        if (teamMembers) {
            teamMembers.innerHTML = '';
            
            if (!equipe.usersDetails || equipe.usersDetails.length === 0) {
                console.warn('⚠️ Aucun membre à afficher');
                teamMembers.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">Aucun membre trouvé</p>';
                return;
            }
            
            console.log(`✅ Affichage de ${equipe.usersDetails.length} membres`);
            
            equipe.usersDetails.forEach((user: any, index: number) => {
                console.log(`Membre ${index + 1}:`, user.prenom, user.nom);
                
                const isChef = user.id === equipe.chef;
                
                const memberDiv = document.createElement('div');
                memberDiv.className = 'flex items-center justify-between p-2.5 sm:p-3 bg-white rounded-xl border-2 border-black';
                
                const memberInfo = document.createElement('div');
                memberInfo.className = 'flex items-center gap-2 sm:gap-3 min-w-0 flex-1';
                
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br from-primary to-tertiary flex items-center justify-center text-white font-oi text-xs sm:text-sm border-2 border-black shrink-0';
                
                if (user.avatar) {
                    const avatarUrl = `http://127.0.0.1:8090/api/files/users/${user.id}/${user.avatar}`;
                    avatarDiv.innerHTML = `<img src="${avatarUrl}" alt="Avatar" class="w-full h-full object-cover rounded-full">`;
                } else {
                    const initials = `${user.prenom?.charAt(0) || ''}${user.nom?.charAt(0) || ''}`.toUpperCase();
                    avatarDiv.textContent = initials || '?';
                }
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'font-nohemi text-black text-sm sm:text-base truncate';
                nameDiv.textContent = `${user.prenom || 'Prénom'} ${user.nom || 'Nom'}`;
                
                memberInfo.appendChild(avatarDiv);
                memberInfo.appendChild(nameDiv);
                memberDiv.appendChild(memberInfo);
                
                if (isChef) {
                    const badge = document.createElement('span');
                    badge.className = 'bg-tertiary text-white px-2 sm:px-3 py-0.5 sm:py-1 rounded-full text-xs font-nohemi font-bold shrink-0';
                    badge.textContent = 'Chef';
                    memberDiv.appendChild(badge);
                }
                
                teamMembers.appendChild(memberDiv);
            });
        }
    }

    const form = document.getElementById('profileForm') as HTMLFormElement;
    form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const prenomInput = document.getElementById('prenom') as HTMLInputElement;
        const nomInput = document.getElementById('nom') as HTMLInputElement;
        const emailInput = document.getElementById('email') as HTMLInputElement;
        const promoInput = document.getElementById('promo') as HTMLSelectElement;
        const confirmPasswordInput = document.getElementById('confirmPassword') as HTMLInputElement;
        
        messageDiv.textContent = '';

        try {
            const userData = JSON.parse(localStorage.getItem('user') || '{}');
            
            const formData = new FormData();
            formData.append('userId', userData.id);
            formData.append('prenom', prenomInput.value);
            formData.append('nom', nomInput.value);
            formData.append('email', emailInput.value);
            formData.append('promo', promoInput.value);
            formData.append('confirmPassword', confirmPasswordInput.value);

            const response = await fetch('/apis/update-profile', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                localStorage.setItem('user', JSON.stringify(data.user));
                
                messageDiv.textContent = data.message;
                messageDiv.style.color = 'green';
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                messageDiv.textContent = data.error || 'Erreur lors de la mise à jour';
                messageDiv.style.color = 'red';
            }

        } catch (error) {
            messageDiv.textContent = 'Erreur de connexion au serveur';
            messageDiv.style.color = 'red';
            console.error(error);
        }
    });

    const toggleConfirmPasswordBtn = document.getElementById('toggleConfirmPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword') as HTMLInputElement;

    toggleConfirmPasswordBtn?.addEventListener('click', () => {
        if (confirmPasswordInput.type === 'password') {
            confirmPasswordInput.type = 'text';
        } else {
            confirmPasswordInput.type = 'password';
        }
    });

    const logoutBtn = document.getElementById('logoutBtn');
    
    logoutBtn?.addEventListener('click', () => {
        logoutBtn.textContent = 'Déconnexion en cours...';
        logoutBtn.style.backgroundColor = '#ef4444';
        
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        
        logoutBtn.textContent = '✓ Déconnecté avec succès';
        logoutBtn.style.backgroundColor = '#22c55e';
        
        setTimeout(() => {
            window.location.href = '/';
        }, 1000);
    });
</script>