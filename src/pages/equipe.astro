---
import Layout from '../layouts/Layout.astro';
import CardEquipe from '../components/CardEquipe.astro';
import { allEquipes } from '../../backend/backend.mjs';

const equipesData = await allEquipes();

const equipesGrouped = equipesData.reduce((acc, row) => {
    if (!acc[row.equipe_nom]) {
        acc[row.equipe_nom] = {
            equipe_nom: row.equipe_nom,
            equipe_logo_url: row.equipe_logo_url,
            membres: []
        };
    }
    acc[row.equipe_nom].membres.push({
        user_nom: row.user_nom,
        user_prenom: row.user_prenom,
        user_avatar_url: row.user_avatar_url,
        user_email: row.user_email
    });
    return acc;
}, {});

const equipes = Object.values(equipesGrouped);
---

<Layout>
    <div class="flex flex-col space-y-15 justify-center items-center mt-25 px-4">
		<h1
			class="text-white font-oi text-center text-4xl sm:text-5xl md:text-6xl lg:text-7xl xl:text-8xl leading-tight sm:leading-tight md:leading-normal tracking-wide">
            Les équipes
        </h1>
        <div class="w-8/10 lg:w-5/10">
            <p class="text-white font-nohemi text-center text-base sm:text-lg mb-4">
                Juste en dessous, découvre la liste des équipes déjà créées et leurs membres.
            </p>
            <p class="text-white font-nohemi text-center text-base sm:text-lg mb-6">
                Tu peux choisir de créer ta propre équipe en cliquant sur "Créer mon équipe". Tu deviendras alors automatiquement chef d'équipe.
            </p>
        </div>
        <div class="flex space-x-6">
            <button id="openCreateModal" class="inline-block bg-primary text-white px-6 sm:px-8 md:px-10 py-2 sm:py-2.5 md:py-3 rounded-full font-nohemi font-black text-base sm:text-lg shadow-[0_0_0_2px_black,3px_3px_0px_1px_black] sm:shadow-[0_0_0_3px_black,4px_4px_0px_2px_black] hover:scale-105 active:scale-95 transition-transform duration-150 ease-in text-center cursor-pointer">
                Créer mon équipe
            </button>
            <button id="openJoinModal" class="inline-block bg-white text-primary px-6 sm:px-8 md:px-10 py-2 sm:py-2.5 md:py-3 rounded-full font-nohemi font-black text-base sm:text-lg shadow-[0_0_0_2px_black,3px_3px_0px_1px_black] sm:shadow-[0_0_0_3px_black,4px_4px_0px_2px_black] hover:scale-105 active:scale-95 transition-transform duration-150 ease-in text-center cursor-pointer">
                Intégrer une équipe
            </button>
        </div>
    </div>

    <div id="createModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-[0_0_0_3px_black,4px_4px_0px_2px_black] relative">
            <button id="closeCreateModal" class="absolute top-4 right-4 text-2xl hover:text-primary transition">✕</button>
            
            <h2 class="font-oi text-primary text-3xl md:text-4xl text-center mb-6">Créer une équipe</h2>
            
            <form id="createForm" class="space-y-4" enctype="multipart/form-data">
                <div>
                    <label for="equipeName" class="block font-nohemi text-black mb-2">Nom de l'équipe</label>
                    <input 
                        type="text" 
                        id="equipeName" 
                        name="equipeName" 
                        required 
                        placeholder="Entrez le nom de votre équipe"
                        class="w-full px-4 py-3 border-3 border-black rounded-xl font-nohemi focus:outline-none focus:ring-2 focus:ring-primary"
                    />
                </div>
                
                <div>
                    <label for="equipeLogo" class="block font-nohemi text-black mb-2">Logo de l'équipe (optionnel)</label>
                    <input 
                        type="file" 
                        id="equipeLogo" 
                        name="equipeLogo" 
                        accept="image/*"
                        class="w-full px-4 py-3 border-3 border-black rounded-xl font-nohemi focus:outline-none focus:ring-2 focus:ring-primary file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-opacity-90"
                    />
                </div>
                
                <button 
                    type="submit"
                    class="w-full bg-primary text-white px-6 py-3 rounded-xl border-3 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] font-nohemi text-lg font-bold hover:scale-105 active:scale-95 transition-transform"
                >
                    Créer l'équipe
                </button>
            </form>
            
            <div id="createMessage" class="mt-4 text-center font-nohemi"></div>
        </div>
    </div>

    <div id="joinModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-[0_0_0_3px_black,4px_4px_0px_2px_black] relative">
            <button id="closeModal" class="absolute top-4 right-4 text-2xl hover:text-primary transition">✕</button>
            
            <h2 class="font-oi text-primary text-3xl md:text-4xl text-center mb-6">Rejoindre une équipe</h2>
            
            <form id="joinForm" class="space-y-4">
                <div>
                    <label for="equipeId" class="block font-nohemi text-black mb-2">ID de l'équipe</label>
                    <input 
                        type="text" 
                        id="equipeId" 
                        name="equipeId" 
                        required 
                        placeholder="Entrez l'ID de l'équipe"
                        class="w-full px-4 py-3 border-3 border-black rounded-xl font-nohemi focus:outline-none focus:ring-2 focus:ring-primary"
                    />
                </div>
                
                <button 
                    type="submit"
                    class="w-full bg-primary text-white px-6 py-3 rounded-xl border-3 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] font-nohemi text-lg font-bold hover:scale-105 active:scale-95 transition-transform"
                >
                    Rejoindre l'équipe
                </button>
            </form>
            
            <div id="message" class="mt-4 text-center font-nohemi"></div>
        </div>
    </div>

    <div class="flex flex-col lg:grid lg:grid-cols-3 w-9/10 mx-auto mt-25 gap-10">
    {equipes.map(equipe => (
        <CardEquipe {...equipe} />
    ))}
    </div>
</Layout>

<script>
    // Gestion de la modale de création d'équipe
    const openCreateModalBtn = document.getElementById('openCreateModal');
    const closeCreateModalBtn = document.getElementById('closeCreateModal');
    const createModal = document.getElementById('createModal');
    const createForm = document.getElementById('createForm') as HTMLFormElement;
    const createMessageDiv = document.getElementById('createMessage') as HTMLDivElement;

    openCreateModalBtn?.addEventListener('click', () => {
        createModal?.classList.remove('hidden');
    });

    closeCreateModalBtn?.addEventListener('click', () => {
        createModal?.classList.add('hidden');
        createMessageDiv.textContent = '';
        createForm?.reset();
    });

    createModal?.addEventListener('click', (e) => {
        if (e.target === createModal) {
            createModal.classList.add('hidden');
            createMessageDiv.textContent = '';
            createForm?.reset();
        }
    });

    const openJoinModalBtn = document.getElementById('openJoinModal');
    const closeModalBtn = document.getElementById('closeModal');
    const joinModal = document.getElementById('joinModal');
    const joinForm = document.getElementById('joinForm') as HTMLFormElement;
    const messageDiv = document.getElementById('message') as HTMLDivElement;

    openJoinModalBtn?.addEventListener('click', () => {
        joinModal?.classList.remove('hidden');
    });

    closeModalBtn?.addEventListener('click', () => {
        joinModal?.classList.add('hidden');
        messageDiv.textContent = '';
        joinForm?.reset();
    });

    // Fermer la modale en cliquant sur le fond
    joinModal?.addEventListener('click', (e) => {
        if (e.target === joinModal) {
            joinModal.classList.add('hidden');
            messageDiv.textContent = '';
            joinForm?.reset();
        }
    });

    createForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const equipeNameInput = document.getElementById('equipeName') as HTMLInputElement;
        const equipeLogoInput = document.getElementById('equipeLogo') as HTMLInputElement;
        const equipeName = equipeNameInput.value.trim();
        
        const userDataString = localStorage.getItem('user');
        if (!userDataString) {
            createMessageDiv.textContent = 'Vous devez être connecté pour créer une équipe.';
            createMessageDiv.style.color = 'red';
            setTimeout(() => {
                window.location.href = '/connexion';
            }, 2000);
            return;
        }
        
        const userData = JSON.parse(userDataString);
        const userId = userData.id;

        try {
            const formData = new FormData();
            formData.append('nom', equipeName);
            formData.append('userId', userId);
            
            if (equipeLogoInput.files && equipeLogoInput.files[0]) {
                formData.append('logo', equipeLogoInput.files[0]);
            }

            const response = await fetch('/apis/create-equipe', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                createMessageDiv.textContent = `${data.message} ID: ${data.equipe.id}`;
                createMessageDiv.style.color = 'green';
                
                setTimeout(() => {
                    createModal?.classList.add('hidden');
                    window.location.reload();
                }, 2000);
            } else {
                createMessageDiv.textContent = data.error || 'Erreur lors de la création de l\'équipe';
                createMessageDiv.style.color = 'red';
            }
        } catch (error) {
            createMessageDiv.textContent = 'Erreur de connexion au serveur';
            createMessageDiv.style.color = 'red';
        }
    });

    // Soumission du formulaire de jonction d'équipe
    joinForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const equipeIdInput = document.getElementById('equipeId') as HTMLInputElement;
        const equipeId = equipeIdInput.value.trim();
        
        // Récupérer l'ID utilisateur depuis localStorage
        const userDataString = localStorage.getItem('user');
        if (!userDataString) {
            messageDiv.textContent = 'Vous devez être connecté pour rejoindre une équipe.';
            messageDiv.style.color = 'red';
            setTimeout(() => {
                window.location.href = '/connexion';
            }, 2000);
            return;
        }
        
        const userData = JSON.parse(userDataString);
        const userId = userData.id;

        try {
            const response = await fetch('/apis/join-equipe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ equipeId, userId })
            });

            const data = await response.json();

            if (response.ok) {
                messageDiv.textContent = data.message;
                messageDiv.style.color = 'green';
                
                // Fermer la modale et rafraîchir après succès
                setTimeout(() => {
                    joinModal?.classList.add('hidden');
                    window.location.reload();
                }, 2000);
            } else {
                messageDiv.textContent = data.error || 'Erreur lors de la jonction à l\'équipe';
                messageDiv.style.color = 'red';
            }
        } catch (error) {
            messageDiv.textContent = 'Erreur de connexion au serveur';
            messageDiv.style.color = 'red';
        }
    });
</script>